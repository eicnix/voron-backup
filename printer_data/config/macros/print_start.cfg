#####################################################################
#   A better print_start macro for v2/trident
#####################################################################

## *** THINGS TO UNCOMMENT: ***
## Bed mesh (2 lines at 2 locations)
## Nevermore (if you have one)
## Z_TILT_ADJUST (For Trident only)
## QUAD_GANTRY_LEVEL (For V2.4 only)
## Beacon Contact logic (if you have one. 4 lines at 4 locations)

[gcode_macro UNLOAD_FILAMENT]
description: Unload filament with homing and positioning
gcode:
    {% set UNLOAD_SPEED = params.SPEED|default(300)|int %}
    {% set UNLOAD_TEMP = params.TEMP|default(260)|int %}
    
    # Save current state
    SAVE_GCODE_STATE NAME=unload_state
    
    # Home if not already homed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    
    # Move to front center position
    G90                          ; Absolute positioning
    G1 Z50 F3000                 ; Raise Z to safe height
    G1 X175 Y340 F6000           ; Move to front center (adjust Y if needed)
    
    # Heat hotend and wait
    M109 S{UNLOAD_TEMP}
    
    # Unload sequence
    M83                          ; Relative extrusion mode
    G1 E5 F300                   ; Small extrusion to ensure filament is melted
    G1 E-15 F1000                ; Quick retract to break string
    G1 E-80 F{UNLOAD_SPEED}      ; Unload filament from hotend and extruder
    
    # Turn off hotend
    M104 S0
    
    # Restore state
    RESTORE_GCODE_STATE NAME=unload_state
    
    M117 Filament unloaded!

[gcode_macro PARK]
gcode:
  SAVE_GCODE_STATE NAME=park_state
  {% if "xy" not in printer.toolhead.homed_axes %}
  RESPOND MSG="Automatically homing XY"
  G28 X Y
  {% endif %}

  {% if "z" not in printer.toolhead.homed_axes %}
    RESPOND MSG="Automatically homing Z"
    G28 Z
  {% endif %}

  {% if printer.quad_gantry_level.applied == False %}
    RESPOND MSG="Automatically QGL"
    QUAD_GANTRY_LEVEL
  {% endif %}

  G1 X11 Y357 F3000

[gcode_macro WIPE]
gcode:
  G90
  {% set cleaningTemperature = 150 %}
  {% set wiperXmin = 17 %}
  {% set wiperYmax = 357 %}
  {% set wiperYmin = 352 %}
  {% set wiperWidth = 2 %}
  {% set wiperLength = 35 %}
  {% set slowFeedrate = 5000 %}
  {% set travelFeedrate = 7000 %}
  {% set waves = 2 %}
  {% set cleaningloops = 1 %}

  G1 X{wiperXmin+(wiperWidth/4)} Y{wiperYmax} F{travelFeedrate}
  
  {% for loops in range(0, cleaningloops) %}
    G90

    G1 X{wiperXmin+wiperLength} Y{wiperYmax-(wiperWidth/4)} F{travelFeedrate}
    
    # Perform pseudosinusoidal cleaning motion
    G91
    {%set xmov=(wiperLength/(waves*4)) %}
    {% for i in range(0,waves) %}
      G1 X-{xmov} Y-{wiperWidth}
      G1 X-{xmov}
      G1 X-{xmov} Y+{wiperWidth}
      G1 X-{xmov}
    {% endfor %}
    G1 Y-{wiperWidth}
    {% for i in range(0,waves) %}
      G1 X{xmov} Y+{wiperWidth}
      G1 X{xmov}
      G1 X{xmov} Y-{wiperWidth}
      G1 X{xmov}
    {% endfor %}

    G1 Y+{wiperWidth}
    {% for i in range(0,waves) %}
      G1 X-{xmov}
      G1 X-{xmov} Y-{wiperWidth}
      G1 X-{xmov}
      G1 X-{xmov} Y+{wiperWidth}
    {% endfor %}
    G1 Y-{wiperWidth}
    {% for i in range(0,waves) %}
      G1 X{xmov}
      G1 X{xmov} Y+{wiperWidth}
      G1 X{xmov}
      G1 X{xmov} Y-{wiperWidth}
    {% endfor %}

    G1 Y+{wiperWidth}
    {% for i in range(0,waves) %}
      G1 X-{xmov*2} Y-{wiperWidth}
      G1 X-{xmov*2} Y+{wiperWidth}
    {% endfor %}
    G1 Y-{wiperWidth}
    {% for i in range(0,waves) %}
      G1 X{xmov*2} Y+{wiperWidth}
      G1 X{xmov*2} Y-{wiperWidth}
    {% endfor %}
  {% endfor %}
 G90

  
[gcode_macro PRINT_START]
gcode:
  # This part fetches data from your slicer. Such as bed, extruder, and chamber temps and size of your printer.
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set target_chamber = params.CHAMBER|default("45")|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}
  {% set min_ext = target_extruder-1 %}
  {% set max_ext = target_extruder+5 %}
  {% set target_chamber = params.CHAMBER|default("40")|int %}
  {% set start_chambertemp = target_chamber - 10 %}

  ##  Uncomment for Beacon Contact (1 of 4 for beacon contact)
  #SET_GCODE_OFFSET Z=0                                 # Set offset to 0

  # Home the printer, set absolute positioning and update the Stealthburner LEDs.
  CG28                                                   # Full home (XYZ)
  G90                                                   # Absolute position
  M400

  ##  Uncomment for bed mesh (1 of 2 for bed mesh)
  BED_MESH_CLEAR                                       # Clear old saved bed mesh (if any)

  {% set current_bed_temp = printer.heater_bed.temperature %}
  {% set tolerance_percentage = 0.10 %}  # 10% tolerance
  {% set lower_bound = target_bed * (1 - tolerance_percentage) %}

 {% if current_bed_temp < lower_bound %}
      RESPOND MSG="Bed temp outside 10% tolerance. Heating..."
      
      M190 S{target_bed}  ; Wait for bed to reach target temperature

      RESPOND MSG="Bed preheated!"
  {% else %}
      # make sure we still set where we want it to be eventually, but do not wait
      M140 S{target_bed}  ; Set bed target temperature
      RESPOND MSG="Bed already within 10% of {target_bed}C"
  {% endif %}
  
  {% if params.CHAMBER|default(0)|int > 0|int %}
    SET_CHAMBER CHAMBER_TEMP={target_chamber}
  {% endif %}

  
  RESPOND MSG="Waiting for chamber to reach (on Gantry Temp): {start_chambertemp}c"           # Displays info
#  {% if start_chambertemp > 10 %}
#    TEMPERATURE_WAIT SENSOR="heater_generic heater_chamber" MINIMUM={start_chambertemp}   ; wait for chamber temp
#  {% else %}
#    TEMPERATURE_WAIT SENSOR="heater_generic heater_chamber" MINIMUM=0   ; wait for chamber temp
#  {% endif %}


  # Heat nozzle to 160°C for accurate Z homing
  SET_DISPLAY_TEXT MSG="Heat up nozzle to 160c"
  M106 S77                                        ; Turns on partcooling fan 30pc to avoid filament leakage
  M104 S160                                       ; Heats the nozzle to 160c
  TEMPERATURE_WAIT SENSOR=extruder minimum=158
  M400                                      

  SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
  CQUAD_GANTRY_LEVEL                                    # Level the printer via QGL
  #PROBE_EDDY_NG_TAP
  #QUAD_GANTRY_LEVEL    
  G28 Z # Level the printer via QGL
  M400
  
  SET_DISPLAY_TEXT MSG="Cleaning Nozzle"
  M104 S{target_extruder}                         ; heat up nozzle to print temperature
  PARK                                            ; Park on nozzle stop area
  TEMPERATURE_WAIT SENSOR=extruder minimum={min_ext}
  M104 S150                                       ; Heat up nozzle to probing temperature
  M106 S255                                       ; Turns on partcooling fan 100pc to aid cooldown
  WIPE               ; Clean nozzle
  PARK                                            ; Park again while nozzle cools down
  TEMPERATURE_WAIT SENSOR=extruder maximum=180 
  WIPE               ; Clean again after cool down
  M400
  M106 S77 ; Reset part cooling fan to 30pc
  M400

  QUAD_GANTRY_LEVEL
  G28 Z
  M400

  ##  Uncomment for bed mesh (2 of 2 for bed mesh)
  SET_DISPLAY_TEXT MSG="Bed mesh"                      # Display info on display
  BED_MESH_CALIBRATE ADAPTIVE=1                                   # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh

  PARK
  TEMPERATURE_WAIT SENSOR=extruder maximum=150
  WIPE
  M400
  CARTOGRAPHER_TOUCH_HOME
  G1 Z30 F1200                                    ; Lift Z height before parking on the rear and handing over to the MMU

  
  M106 S255                                       ; Turns on partcooling fan 100pc to avoid filament leakage
  {% if target_extruder|int < 255 %} 
    M104 S255                                     ; Purge at 255C
  {% else %}
    M104 S{target_extruder}                       ; Purge at material print temperature
  {% endif %}
  
  PARK                                            ; Park nozzle

  {% if target_extruder|int < 255 %} 
    TEMPERATURE_WAIT SENSOR=extruder minimum=245
  {% else %}
    TEMPERATURE_WAIT SENSOR=extruder minimum={target_extruder-5}
  {% endif %}                             
  

  ## Uncomment for Beacon Contact (3 of 4 for beacon contact)
  #G28 Z METHOD=CONTACT CALIBRATE=0                     # Calibrate z offset only with hot nozzle

  # Heat up the hotend up to target via data from slicer
 

  ##   Uncomment for Beacon Contact (4 of 4 for beacon contact)
  #SET_GCODE_OFFSET Z=0.06                              # Add a little offset for hotend thermal expansion
  {% set target_extruder = params.EXTRUDER|int %}
  {% set min_ext = target_extruder-1 %}
  {% set max_ext = target_extruder+5 %}

  # Heat nozzle to printing temperature
  SET_DISPLAY_TEXT MSG="Heating nozzle to print temperature..."
  M104 S{target_extruder}
  M106 S255                                       ; Fan at 100 pc
  PARK
  TEMPERATURE_WAIT SENSOR=extruder minimum={min_ext} maximum={max_ext}


  SKEW_PROFILE LOAD=Calilantern
  # Get ready to print by doing a primeline and updating the LEDs
  SET_DISPLAY_TEXT MSG="Printer goes brr"               # Display info on display
  G0 X{x_wait - 50} Y4 F10000                           # Go to starting point
  G0 Z0.4                                               # Raise Z to 0.4
  G91                                                   # Incremental positioning 
  G1 X100 E20 F1000                                     # Primeline
  G90                                                   # Absolute position

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
  # safe anti-stringing move coords
  {% set th = printer.toolhead %}
  {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
  {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
  {% set z_safe = [th.position.z + 10, th.axis_maximum.z]|min %}
  #{% set bedtemp = printer.heater_bed.target %}
  
  _RESET_PRINTER_TO_KLIPPER_CONFIG

  #TURN_OFF_HEATERS
  #cancel_adaptive_exhaust
  #SET_CHAMBER CHAMBER_TEMP=0
  
  M400                                     ; wait for buffer to clear
  G90                                      ; absolute positioning
  G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
  G0 X175 Y330 F7200   ; park nozzle at the rear for easy cleaning
  G90

  {% if z_safe < 100 %}       ; check if current Z is below 100mm
    G1 Z100 F900              ; raise Z up
  {% endif %}

  M400
  TIMELAPSE_TAKE_FRAME
  M400

  SET_LED LED=disco1 RED=0.4 GREEN=0.4 BLUE=0.4
  M400
                                  

  # Cooldown and venting control
  {% if bedtemp > 90 %}
      # High-temp build – keep bed heater on, run exhaust at 15% for 15 minutes to filter the air.
      close_vent                                                ; Make sure vent is closed
      SET_FAN_SPEED FAN=exhaust_fan SPEED=0.20                  ; Exhaust fan at low speed for gradual filtering            
      M140 S{bedtemp-10}                                        ; Reduce bed temperature slightly 
      M106 S13                                                  ; Part cooling fan to 10pc to prevent cowling deformation
      UPDATE_DELAYED_GCODE ID=POST_PRINT_BED_SWITCH_OFF DURATION=1800  ; Wait for 30 mins before full shutdown.
      UPDATE_DELAYED_GCODE ID=POST_PRINT_COOLDOWN DURATION=3000  ; Wait for 50 mins before full shutdown.
  {% else %}
      # Low-temp build – shut heaters now, vent for two minutes
      SET_CHAMBER CHAMBER_TEMP=0
      M107                                                      ; Part-cooling fan off
      open_vent                                                 ; Ventilation open to dump any residual heat out
      SET_FAN_SPEED FAN=exhaust_fan SPEED=0.4                   ; Exhaust at 40 percent
      UPDATE_DELAYED_GCODE ID=POST_PRINT_COOLDOWN DURATION=120
  {% endif %}

  SET_LED LED=disco1 RED=0.1 GREEN=0.1 BLUE=0.1
  M117
  M400
  SET_DISPLAY_TEXT MSG="COMPLETE" # Displays info
  
  SET_GCODE_OFFSET Z=0
  BED_MESH_CLEAR
  M400
  M84  